# TM - Требования безопасности + Модель угроз + ADR

## 0) Мета

- **Проект:** «учебный шаблон»
- **Версия:** 2025-12-06
- **Кратко:** 
Сервис управления профилем, который позволяет пользователям загружать аватары, \
выгружать архивы своих данных (экспорт) и агрегирует информацию от внешнего партнера (Vendor X).

---

## 1) Архитектура и границы доверия (TM1, S04)

- **Роли/активы:** 
1. Пользователь (User): Авторизованный клиент, который загружает аватары и запрашивает экспорт данных.
2. Внешний Провайдер (Vendor X): Сторонний сервис, с которым происходит интеграция.
3. Администратор/SRE: Потребитель логов и метрик (неявный участник, для которого важны NFR-005, NFR-007).

- **Зоны доверия:** 
1. Internet (Недоверенная): Источник произвольных, потенциально вредоносных запросов (SQLi, большие файлы, некорректные MIME-типы)
2. DMZ / Service API (Пограничная): Слой контроллеров (API Gateway), где терминируется SSL, проверяются токены и происходит валидация входных данных (NFR-001, NFR-002).
3. Internal (Доверенная): Ядро бизнес-логики и База Данных. Доступ сюда разрешен только после прохождения проверок на слое API.
4. External (Сторонняя): Контур провайдера Vendor X. Считается функционально доверенным (по контенту), но технически ненадежным (по доступности).

- **Context/DFD:** \
https://github.com/titarenko-a-v/secdev-lite-titarenko/blob/main/EVIDENCE/dfd_context.png \
Mermaid можно увидеть в S03: \
https://github.com/titarenko-a-v/secdev-lite-titarenko/blob/main/SEMINARS/S03/S03_register.md

- **Критичные интерфейсы и допущения:**  
Мы считаем, что валидация JWT и Rate Limiting (NFR-003) отрабатывают до выполнения тяжелой бизнес-логики.
Мы не доверяем доступности Vendor X, поэтому использование Circuit Breaker — критическое условие стабильности.
Мы допускаем, что логи могут читать разработчики, поэтому маскирование PII (NFR-005) — обязанность Application Layer, а не инфраструктуры.
---

## 2) Реестр угроз STRIDE (TM2, TM3, S04)

| ID   | STRIDE | Компонент/поток     | Угроза (кратко)                                              | L | I | L×I |
|------|--------|----------------------|---------------------------------------------------------------|---|---|-----|
| R-01 | D      | Logic → Vendor       | Каскадный сбой сервиса из-за зависания внешнего API          | 4 | 5 | 20  |
| R-02 | T      | User → API           | Загрузка вредоносного файла (RCE/XSS) под видом картинки      | 3 | 5 | 15  |
| R-03 | I      | Logic → Logs         | Утечка PII (перс. данных) в логи при ошибках/отладке          | 5 | 3 | 15  |
| R-04 | D      | User → API           | DoS публичного API массовой загрузкой или экспортом           | 4 | 3 | 12  |
| R-05 | E      | API → Logic          | IDOR: доступ к чужому экспорту через подмену ID               | 3 | 4 | 12  |
| R-06 | R      | Logic → Vendor       | Невозможность трассировки ошибок вендора (No Corr-ID)         | 5 | 2 | 10  |
| R-07 | D      | Logic → DB           | Блокировка БД тяжелыми запросами на экспорт                   | 3 | 3 | 9   |

---

## 3) Приоритизация и Top-5 _(TM3, S04)_

1) **R-01 Cascading Failure** — L×I=20; риск полной остановки сервиса; внешние зависимости ненадёжны.  
2) **R-02 Malicious File Upload** — L×I=15; возможен RCE; критично для безопасности инфраструктуры.  
3) **R-03 PII Leak in Logs** — L×I=15; затрагивает персональные данные; несёт юридические последствия.  
4) **R-04 Public API DoS** — L×I=12; публичная поверхность атаки; отсутствие ограничений повышает уязвимость.  
5) **R-05 IDOR on Export** — L×I=12; риск утечки пользовательских данных; важна строгая проверка прав доступа.

---

## 4) Требования (S03) и ADR-решения (S05) под Top-5 (TM4)

---

### **Группа NFR: Устойчивость и Интеграция (Resilience)**  
**Связанные риски:** R-01 (Cascading Failure)

#### **NFR-008 (Circuit Breaker)**

**AC (GWT):**  
Given ≥50% ошибок `GET /api/integrations/vendor-x/*` за минуту (или таймаутов),  
When обрабатываются новые запросы,  
Then circuit breaker переходит в состояние **Open** и блокирует новые вызовы; события фиксируются в логах как `circuit_breaker_on`.

---

#### **NFR-009 (Timeout/Retry)**

**AC (GWT):**  
Given недоступность `GET /api/integrations/vendor-x/*` (задержка ответа > 2с),  
When сервис обращается к интеграции,  
Then соединение обрывается через 2 секунды; выполняется **не более 3 retry** с джиттером.

---

#### **NFR-007 (Observability)**

**AC (GWT):**  
Given запрос с `X-Correlation-ID`,  
When он проходит сервис и уходит к вендору,  
Then во всех логах (app и access) присутствует `correlation_id`.

---

### **Группа NFR: Безопасность ввода (Input Validation)**  
**Связанные риски:** R-02 (Malware Upload), R-04 (DoS)

#### **NFR-001 (Size Limit)**

**AC (GWT):**  
Given тело запроса больше **15 MiB**,  
When `POST /api/files/avatar`,  
Then соединение прерывается или возвращается **413 Payload Too Large** (RFC7807).

---

#### **NFR-002 (MIME Type)**

**AC (GWT):**  
Given файл с расширением `.jpg`, но заголовком `application/x-sh` или неверными magic bytes,  
When `POST /api/files/avatar`,  
Then возвращается **413/422**, файл не сохраняется.

---

### **Группа NFR: Защита от нагрузки и Приватность**  
**Связанные риски:** R-03 (PII), R-04 (DoS)

#### **NFR-003 / NFR-004 (Rate Limiting)**

**AC (GWT):**  
Given активный токен,  
When выполняется **10+N запросов за 60 секунд** к критичным ручкам,  
Then возвращается **429 Too Many Requests**.

---

#### **NFR-005 (PII Masking)**

**AC (GWT):**  
Given DTO с персональными данными (email, phone),  
When происходит логирование payload или ошибки,  
Then поля PII маскированы (`***`) или удалены.

---

### **Архитектурные решения (ADR)**

#### **ADR-001: Resilient Integration with Vendor X (Circuit Breaker)**

**Context:** Risk R-01 (Cascading Failure), NFR-008, NFR-009. Внешний вендор ненадёжный.  
**Decision:** Внедрить Circuit Breaker + Timeouts (2s) + Retries (x3) на HTTP-клиенте.  
**Trade-offs:** Повышает устойчивость (Fail Fast), но ошибки партнера станут видны пользователю. Требует настройки порогов.  
**DoD:** Integration Test с MockServer (latency 5s) → CB открывается, p99 latency < 2.1s.  
**Owner:** Integration Team  
**Evidence:** `integration-cb-trigger`, лог `circuit_breaker_state_change`

---

#### **ADR-002: Secure Avatar Upload Validation Strategy**

**Context:** Risk R-02 (RCE/Malware), Risk R-04 (DoS), NFR-001, NFR-002.  
**Decision:** Многоуровневая валидация до сохранения:  
1. Magic Bytes (не доверять Content-Type)  
2. Allowlist: jpg/png  
3. Limit: 15MB  
4. Имя файла — UUID  

**Trade-offs:** Доп. нагрузка на CPU; некоторые битые изображения будут отбрасываться.  
**DoD:** polyglot-файлы отклоняются (422); файл на диске — UUID.  
**Owner:** Security Champion  
**Evidence:** `SecurityUploadTest`, лог `upload_rejected reason="invalid_magic_bytes"`

---

## 5) Трассировка Threat → NFR → ADR → (План) Проверки (TM5)

| Threat | NFR | ADR | Чем проверяем (план/факт) |
|--------|------|------|-----------------------------|
| **R-01 (Cascading Failure)** | NFR-008<br>NFR-009 | ADR-001 | **Test:** Integration Test (MockServer latency > 2s).<br>**Log:** поиск события `circuit_breaker_state_change` в Splunk/ELK. |
| **R-02 (Malicious File)** | NFR-002 | ADR-002 | **Test:** SecurityUploadTest (polyglots, renamed exe).<br>**E2E:** загрузка `webshell.php.jpg` → 422. |
| **R-04 (Public API DoS)** | NFR-001<br>NFR-003 | ADR-002 (partial) | **Test:** e2e-upload-limit (файл 16MB).<br>**Load Test:** 20 RPS на `/avatar` → проверка 429. |
| **R-03 (PII Leak)** | NFR-005 | — | **Log Review:** grep по email/phone → проверка маскирования `*`. |
| **R-06 (Untraceable Errors)** | NFR-007 | ADR-001 (trace) | **Trace:** проверка `X-Correlation-ID` в исходящем запросе к вендору (Wireshark/Logs). |

---

## 6) План проверок (мост в DV/DS)

- **SAST/Secrets/SCA:** Будут настроены статические анализаторы кода и сканеры зависимостей в рамках CI/CD пайплайна. \
Отчёты о проверках планируется сохранять в директорию EVIDENCE/ после каждой сборки.
- **SBOM:** Состав программных компонентов будет автоматически фиксироваться на этапе сборки в одном из стандартных форматов.

---

## 7) Самопроверка по рубрике TM (0/1/2)

- **TM1. Архитектура и границы доверия:** 2  
- **TM2. Покрытие STRIDE и уместность угроз:** 2  
- **TM3. Приоритизация и Top-5:** 2  
- **TM4. NFR + ADR под Top-5:** 2  
- **TM5. Трассировка → (план)проверок:** 2  

**Итог TM (сумма):** 10/10
